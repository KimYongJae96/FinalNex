<?xml version="1.0" encoding="utf-8"?>
<FDL version="2.1">
  <Form id="students" width="1080" height="570" titletext="New Form">
    <Layouts>
      <Layout height="570" mobileorientation="landscape" width="1080">
        <Grid id="Grid00" taborder="0" left="20" top="40" width="1040" height="425" binddataset="ds_students" autofittype="col" onheadclick="Grid00_onheadclick">
          <Formats>
            <Format id="default">
              <Columns>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="84"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
                <Column size="80"/>
              </Columns>
              <Rows>
                <Row size="24" band="head"/>
                <Row size="24"/>
              </Rows>
              <Band id="head">
                <Cell displaytype="checkboxcontrol" edittype="checkbox"/>
                <Cell col="1" text="학번"/>
                <Cell col="2" text="gender"/>
                <Cell col="3" text="colCode"/>
                <Cell col="4" text="deptCode"/>
                <Cell col="5" text="name"/>
                <Cell col="6" text="secNumber"/>
                <Cell col="7" text="email"/>
                <Cell col="8" text="contact"/>
                <Cell col="9" text="address"/>
                <Cell col="10" text="scholarship"/>
                <Cell col="11" text="rest"/>
                <Cell col="12" text="grade"/>
              </Band>
              <Band id="body">
                <Cell text="bind:chk" displaytype="checkboxcontrol" edittype="checkbox"/>
                <Cell col="1" text="bind:s_seq"/>
                <Cell col="2" text="bind:gender" edittype="combo" combodataset="ds_gender" combocodecol="code" combodatacol="name"/>
                <Cell col="3" text="bind:colCode" edittype="combo" combodataset="colCode" combocodecol="code" combodatacol="name"/>
                <Cell col="4" text="bind:deptCode" edittype="combo" combodataset="deptCode" combocodecol="code" combodatacol="name"/>
                <Cell col="5" text="bind:name" edittype="normal"/>
                <Cell col="6" text="bind:secNumber" displaytype="mask" edittype="mask" maskedittype="string" maskeditformat="###### - #######"/>
                <Cell col="7" text="bind:email" edittype="normal"/>
                <Cell col="8" text="bind:contact" edittype="normal"/>
                <Cell col="9" text="bind:address" edittype="normal"/>
                <Cell col="10" text="bind:scholarship" edittype="normal"/>
                <Cell col="11" text="bind:rest" edittype="combo" combodataset="ds_rest" combocodecol="code" combodatacol="name"/>
                <Cell col="12" text="bind:grade"/>
              </Band>
            </Format>
          </Formats>
        </Grid>
        <Button id="btn_retrive" taborder="1" text="조회" left="1020" top="10" width="40" height="30" onclick="btn_retrive_onclick"/>
        <Button id="btn_save" taborder="2" text="저장" left="1020" top="465" width="40" height="30" onclick="btn_save_onclick"/>
        <Button id="btn_del" taborder="3" text="삭제" left="960" top="465" width="40" height="30" onclick="btn_del_onclick"/>
        <Button id="btn_add" taborder="4" text="입력" left="20" top="10" width="40" height="30" onclick="btn_add_onclick"/>
        <Combo id="cb_search" taborder="5" text="전체" left="100" top="10" width="100" height="30" value="All" index="0" innerdataset="innerdataset" codecolumn="codecolumn" datacolumn="datacolumn" onitemchanged="cb_search_onitemchanged">
          <Dataset id="innerdataset">
            <ColumnInfo>
              <Column id="codecolumn" size="256"/>
              <Column id="datacolumn" size="256"/>
            </ColumnInfo>
            <Rows>
              <Row>
                <Col id="codecolumn">All</Col>
                <Col id="datacolumn">전체</Col>
              </Row>
              <Row>
                <Col id="codecolumn">s_seq</Col>
                <Col id="datacolumn">학번</Col>
              </Row>
            </Rows>
          </Dataset>
        </Combo>
        <Edit id="edt_search" taborder="6" left="220" top="10" width="100" height="30"/>
        <Button id="btn_search" taborder="7" text="검색" left="330" top="10" width="40" height="30" onclick="btn_search_onclick"/>
      </Layout>
    </Layouts>
    <Script type="xscript5.1"><![CDATA[this.fn_callback = function(id,ErrorCode,ErrorMsg){	//콜백함수
	trace(id);
	trace(ErrorMsg);
	trace(ErrorCode);
}
this.fn_update_students = function(id,url){	//업데이트 따로 뺀것
  this.transaction(
            id 
            ,url 
            ,"in_ds=ds_students:U"
            ,"" 
            ,""
            ,"fn_callback" 
         )
}


this.btn_retrive_onclick = function(obj:nexacro.Button,e:nexacro.ClickEventInfo)
{
	this.transaction(

				"ds_retrive" //1. strSvcID
				,"/studentslist.nex" //2. strURL
				,"" //3.strInDatasets - I,U,D Sds=Fds:U 변경된값만보내겟다, :A, :N
				,"ds_students=out_ds" //4.strOutDatasets -select Fds=Sds
				,"" //5.strArgument text값
				,"fn_callback" //6.strCallbackFunc
			);
	this.ds_students.filter("");
};

this.btn_save_onclick = function(obj:nexacro.Button,e:nexacro.ClickEventInfo)
{
	if(this.confirm("저장하시겠습니까?")){
	this.fn_update_students("dsUpdate","/updateStudent.nex");
	trace(this.ds_students.getColumnInfo("birth"));
	}
	
};

this.btn_del_onclick = function(obj:nexacro.Button,e:nexacro.ClickEventInfo)
{
	let arr = this.ds_students.extractRows("chk==1");
	
	if(arr.length==0 || arr.length== -1){alert("선택된 항목이 없습니다.");return;}
	
	if(this.confirm("삭제하시겠습니까?")){
	this.ds_students.deleteMultiRows(arr);
	this.fn_update_students("dsDel","/deleteStudent.nex");
	}
};

this.btn_add_onclick = function(obj:nexacro.Button,e:nexacro.ClickEventInfo)
{
	let x = this.width/2;
	let y = this.height/2;
	let objCF = new ChildFrame();
	objCF.init("insertpop",0,0,300,550,0,0,"admWork::insertStudent.xfdl");
	objCF.set_showtitlebar(false);
	objCF.showModal(this.getOwnerFrame(),{},this,"fn_callback");
};

this.Grid00_onheadclick = function(obj:nexacro.Grid,e:nexacro.GridClickEventInfo)
{
	let flag = obj.getCellProperty("Head",0,"text");
	let check = flag==0?1:0;
	if(e.cell == 0){
		obj.setCellProperty("Head",0,"text",check);
		for(let i = 0; i<this.ds_students.rowcount; i++){
		 this.ds_students.setColumn(i,"chk",check);
		}
	}
	
	var objDs = this.objects[obj.binddataset];          
	for (var i = 1; i < obj.getCellCount("head"); i++)
	{ 
		var sHeadText = obj.getCellText(-1, i);
		var nLen   = sHeadText.length - 1;    
		if (i == e.cell)
		{	
			var sColId = (obj.getCellProperty("body", e.col,"text")).toString().split(":");
			if (sHeadText.substr(nLen) == "▲") 
			{
				obj.setCellProperty( "head", i, "text", sHeadText.substr(0, nLen)+ "▼");
				objDs.set_keystring("S:-" + sColId[1]);
			}
			else if (sHeadText.substr(nLen) == "▼") 
			{
				obj.setCellProperty( "head", i, "text", sHeadText.substr(0, nLen)+ "▲"); 
				objDs.set_keystring("S:+" + sColId[1]);
			}
			else 
			{
				obj.setCellProperty( "head", i, "text", sHeadText+"▲");
				objDs.set_keystring("S:+" + sColId[1]);
			}
		}
		else
		{
			if (sHeadText.substr(nLen) == "▲" || sHeadText.substr(nLen) == "▼")  
			{
				obj.setCellProperty( "head", i, "text", sHeadText.substr(0, nLen));
			}
		}
	} 
	
};

this.btn_search_onclick = function(obj:nexacro.Button,e:nexacro.ClickEventInfo)
{
	let cbValue = this.cb_search.value;
	let edtValue = this.edt_search.text;
	trace(this.cb_search.value);
	trace(cbValue);
	trace(this.edt_search.text);
	trace(edtValue);
	
	if(cbValue == "s_seq"){
		this.ds_students.filter(cbValue +"=='"+edtValue+"'");
		trace(this.ds_students);
	}else{
		this.ds_students.filter("");
	}
};
]]></Script>
    <Objects>
      <Dataset id="ds_students">
        <ColumnInfo>
          <Column id="chk" type="STRING" size="256"/>
          <Column id="s_seq" type="STRING" size="256"/>
          <Column id="gender" type="STRING" size="256"/>
          <Column id="deptCode" type="STRING" size="256"/>
          <Column id="name" type="STRING" size="256"/>
          <Column id="secNumber" type="STRING" size="256"/>
          <Column id="email" type="STRING" size="256"/>
          <Column id="contact" type="STRING" size="256"/>
          <Column id="address" type="STRING" size="256"/>
          <Column id="scholarship" type="STRING" size="256"/>
          <Column id="rest" type="STRING" size="256"/>
          <Column id="colCode" type="STRING" size="256"/>
          <Column id="grade" type="STRING" size="256"/>
        </ColumnInfo>
      </Dataset>
      <Dataset id="ds_gender">
        <ColumnInfo>
          <Column id="code" type="STRING" size="256"/>
          <Column id="name" type="STRING" size="256"/>
        </ColumnInfo>
        <Rows>
          <Row>
            <Col id="code">M</Col>
            <Col id="name">남자</Col>
          </Row>
          <Row>
            <Col id="code">W</Col>
            <Col id="name">여자</Col>
          </Row>
        </Rows>
      </Dataset>
      <Dataset id="ds_rest">
        <ColumnInfo>
          <Column id="code" type="STRING" size="256"/>
          <Column id="name" type="STRING" size="256"/>
        </ColumnInfo>
        <Rows>
          <Row>
            <Col id="code">Y</Col>
            <Col id="name">휴학</Col>
          </Row>
          <Row>
            <Col id="code">N</Col>
            <Col id="name">재학</Col>
          </Row>
        </Rows>
      </Dataset>
    </Objects>
  </Form>
</FDL>
